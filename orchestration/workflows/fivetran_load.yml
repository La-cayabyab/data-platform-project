id: fivetran_load
namespace: demo

tasks:
  - id: sync
    type: io.kestra.core.tasks.scripts.Bash
    runner: PROCESS
    commands:
      - |
        API_KEY=$(cat /workspace/.secret_keys/fivetran_api_key.txt)
        API_SECRET=$(cat /workspace/.secret_keys/fivetran_api_secret.txt)
        AUTH=$(echo -n "$API_KEY:$API_SECRET" | base64)
        
        CONNECTORS="posts comments users"
        FAILED=""
        
        for NAME in $CONNECTORS; do
          CONNECTOR_ID=$(cat /workspace/.secret_keys/fivetran_connector_"$NAME"_id.txt 2>/dev/null | xargs)
          
          if [ -z "$CONNECTOR_ID" ]; then
            echo "‚ö†Ô∏è  Skipping $NAME: file not found"
            continue
          fi
          
          echo "üîÑ Triggering sync for $NAME ($CONNECTOR_ID)..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Basic $AUTH" \
            "https://api.fivetran.com/v1/connectors/$CONNECTOR_ID/force")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ $NAME sync triggered successfully"
            echo "Response: $BODY"
          else
            echo "‚ùå $NAME failed to trigger (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
            FAILED="$FAILED $NAME"
          fi
        done
        
        echo ""
        [ -z "$FAILED" ] && echo "‚úÖ All syncs completed" || (echo "‚ùå Failed:$FAILED" && exit 1)
